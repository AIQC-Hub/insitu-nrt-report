---
title: "Summary of Baltic Sea (BO)"
description: |
  Summary report generated from a single Parquet file has been created from over 750 NetCDF files from Baltic Sea NRT in situ observations.
output: 
  distill::distill_article:
    toc: true
    toc_depth: 2
---

```{r include = FALSE}
knitr::opts_chunk$set(echo=FALSE)
r_func_path <- "./_func"
r_funcs <- c("libraries.Rmd", "common.Rmd", "common_bo.Rmd", "netcdf_bo.Rmd")
```

```{r, import, child=file.path(r_func_path, r_funcs)}
```

```{r, echo = FALSE, message = FALSE, warning = FALSE}
# Common variables
rsc_dir <- "/scratch/data/aiqc/merged/nrt_bo"
#rsc_dir <- "./resources"

bo_file_name <- file.path(rsc_dir, "netcdf_nrt_bo.parquet")
df_bo <- read_parquet(bo_file_name)
df_bo_uniq_profiles <- get_unique_profile_no(df_bo)

```

## 1. Basic Information

### NetCDF files
  - **Dataset ID**: [cmems_obs-ins_bal_phybgcwav_mynrt_na_irr](https://doi.org/10.48670/moi-00032)
  - **Duration**: history
  - **Region**: Baltic Sea (BO)
  - **Category**: CT (CTD)

### Parquet file

  - **BO data**: netcdf_nrt_bo.parquet

---

## 2. Descriptive Statistics of BO CTD Data

```{r, echo = FALSE, message = FALSE, warning = FALSE}
summary_table <- df_bo %>%
  summarise(across(everything(), ~ typeof(.))) %>%
  t() %>% as.data.frame() %>% 
  rownames_to_column("Variable") %>% as_tibble() %>% 
  select(Variable, Type=2)

summary_table_netcdf <- netcdf_summary_1(df_bo)
summary_table_netcdf2 <- netcdf_summary_2(summary_table_netcdf)
summary_loc_table <- netcdf_loc_summary(summary_table_netcdf2)

```

 - **Number of observations**: `r formatC(nrow(df_bo), big.mark=",")`
 - **Number of platform**: `r formatC(nrow(summary_table_netcdf2), big.mark=",")`
 - **Number of profiles**: `r formatC(sum(summary_table_netcdf2$profile_count), big.mark=",")`


### Summary statistics by profiles

```{r, echo = FALSE, message = FALSE, warning = FALSE, results = 'asis'}
summary_table_netcdf2 <- format_netcdf_summary_2(summary_table_netcdf2)
create_dt_summary_tab(summary_table_netcdf2)

```

---

## 3. Locations

 - **Longitude**: `r round(min(summary_loc_table[, "Min(Lon)"]), 3)` to `r round(max(summary_loc_table[, "Max(Lon)"]), 3)`
 - **Latitude**: `r round(min(summary_loc_table[, "Min(Lat)"]), 3)` to `r round(max(summary_loc_table[, "Max(Lat)"]), 3)`


### Locations by profiles

```{r, echo = FALSE, message = FALSE, warning = FALSE, results = 'asis'}
loc_table_cols <- c("Min(Lon)", "Max(Lon)", "Diff(Lon)", 
                    "Min(Lat)" ,"Max(Lat)", "Diff(Lat)")
create_dt_summary_tab(summary_loc_table, cols=loc_table_cols)

```

### Mapped locations of all profiles and three selected platforms

```{r, echo = FALSE, message = FALSE, warning = FALSE, fig.width = 10, fig.height = 10}
lat_range <- range(summary_table_netcdf$latitude)
lon_range <- range(summary_table_netcdf$longitude)

p_long_x_lat <- summary_table_netcdf %>%
 create_region_scatter("Scatter plot with positions", lat_range, lon_range)

p_long_x_lat_UMFF9A13 <- get_loc_by_platform(summary_table_netcdf, "UMFF9A13") %>%
  create_region_scatter("Platform: UMFF9A13", lat_range, lon_range)

p_long_x_lat_UMFNB1B3 <- get_loc_by_platform(summary_table_netcdf, "UMFNB1B3") %>%
  create_region_scatter("Platform: UMFNB1B3", lat_range, lon_range)

p_long_x_lat_SMHIRR7 <- get_loc_by_platform(summary_table_netcdf, "SMHIRR7") %>%
  create_region_scatter("Platform: SMHIRR7", lat_range, lon_range)

print(plot_grid(p_long_x_lat, p_long_x_lat_UMFF9A13,
                p_long_x_lat_UMFNB1B3, p_long_x_lat_SMHIRR7, nrow = 2))

```

### Histograms of longitudes and latitudes from all profiles

```{r, echo = FALSE, message = FALSE, warning = FALSE, fig.width = 10}

p_long_dense <- summary_table_netcdf %>% mutate(x = longitude) %>%
  create_region_hist("Histogram of longitude", "Longitude")
p_lat_dense <- summary_table_netcdf %>% mutate(x = latitude) %>%
  create_region_hist("Histogram of latitude", "Latitude")

print(plot_grid(p_long_dense, p_lat_dense, nrow = 1))

```

---

## 4. Distribution of profiles over time

### Number of profiles

```{r, echo = FALSE, message = FALSE, warning = FALSE, fig.width = 10}

df_year <- summary_table_netcdf %>%
  mutate(x = format(profile_timestamp, "%Y"))

df_month <- summary_table_netcdf %>%
  mutate(x = format(profile_timestamp, "%m"))

df_year_month <- summary_table_netcdf %>%
  mutate(x = format(profile_timestamp, "%Y-%m"))

```

#### Year

```{r, echo = FALSE, message = FALSE, warning = FALSE, fig.width = 10}
p_year_hist <- create_sample_time_hist(df_year, "Year")

print(p_year_hist)
```

#### Month

```{r, echo = FALSE, message = FALSE, warning = FALSE, fig.width = 10}
p_month_hist <- create_sample_time_hist(df_month, "Month")

print(p_month_hist)
```

### Mapped locations of four time spans

 - **ts7889**: `r paste0(ts7889_from, " ~ ", ts7889_to)`
 - **ts9006**: `r paste0(ts9006_from, " ~ ", ts9006_to)`
 - **ts07A2**: `r paste0(ts07A2_from, " ~ ", ts07A2_to)`
 - **tsA3B5**: `r paste0(tsA3B5_from, " ~ ", tsA3B5_to)`

```{r, echo = FALSE, message = FALSE, warning = FALSE, fig.width = 10, fig.height = 10}

ts_lst <- split_time_spans(summary_table_netcdf)

p_long_x_lat_ts7889 <- get_loc_by_timespan(ts_lst, "ts7889") %>%
  create_region_scatter("Time span: ts7889", lat_range, lon_range)

p_long_x_lat_ts9006 <- get_loc_by_timespan(ts_lst, "ts9006") %>%
  create_region_scatter("Time span: ts9006", lat_range, lon_range)

p_long_x_lat_ts07A2 <- get_loc_by_timespan(ts_lst, "ts07A2") %>%
  create_region_scatter("Time span: ts07A2", lat_range, lon_range)

p_long_x_lat_tsA3B5 <- get_loc_by_timespan(ts_lst, "tsA3B5") %>%
  create_region_scatter("Time span: tsA3B5", lat_range, lon_range)

print(plot_grid(p_long_x_lat_ts7889, p_long_x_lat_ts9006,
                p_long_x_lat_ts07A2, p_long_x_lat_tsA3B5, nrow = 2))
```

---

## 5. Duplicate profiles within platforms

### Detection criteria

To identify potential duplicate profiles, the following variables must match:

 - Platform (`platform_code`)
 - Timestamp (`profile_timestamp`)
 - Rounded precise longitude (`round(precise_longitude, 3)`)
 - Rounded precise latitude (`round(precise_latitude, 3)`)

### Duplicate profiles

```{r, echo = FALSE, message = FALSE, warning = FALSE}
df_dup_within <- find_duplicates_within_platforms(df_bo)

create_dt_summary_tab(df_dup_within %>%
  dplyr::select(`Platform` = 1, `Profiles` = 5, Timestamp = 2,
                `Lon` = 3, `Lat` = 4, n))

```

---

## 6. Duplicate profiles across platforms

### Detection criteria

To identify potential duplicate profiles, the following variables must match:

 - Timestamp (`profile_timestamp`)
 - Rounded precise longitude (`round(precise_longitude, 3)`)
 - Rounded precise latitude (`round(precise_latitude, 3)`)

### Duplicate profiles

```{r, echo = FALSE, message = FALSE, warning = FALSE}
df_dup_across <- find_duplicates_across_platforms(df_bo)

create_dt_summary_tab(df_dup_across %>%
  dplyr::select(`Platforms` = 4, `Profiles` = 5, Timestamp = 1,
                `Lon` = 2, `Lat` = 3, n))

```

---

## 7. Observation counts by profile

### Histograms of observation counts per profile

```{r, echo = FALSE, message = FALSE, warning = FALSE, fig.width = 10}

summary_table_netcdf_d100 <- summary_table_netcdf %>%
  filter(obs_count <= 100)
summary_table_netcdf_d30 <- summary_table_netcdf %>%
  filter(obs_count <= 30)
summary_table_netcdf_d3000 <- summary_table_netcdf %>%
  filter(obs_count >= 3000)

p_obs_count_hist <- create_obs_count_hist(summary_table_netcdf, "All values")
p_obs_count_hist_d100 <- create_obs_count_hist(summary_table_netcdf_d100, "Filtered by ≤100")
p_obs_count_hist_d30 <- create_obs_count_hist(summary_table_netcdf_d30, "Filtered by ≤30")
p_obs_count_hist_d3000 <- create_obs_count_hist(summary_table_netcdf_d3000, "Filtered by ≥3000")

print(plot_grid(p_obs_count_hist, p_obs_count_hist_d100,
                p_obs_count_hist_d30, p_obs_count_hist_d3000,
                nrow = 2))

```

### Mapped locations of 1, 2, 3000-3600, and ≥4000 observations

```{r, echo = FALSE, message = FALSE, warning = FALSE, fig.width = 10, fig.height = 10}

p_long_x_lat_obs1 <- summary_table_netcdf %>% filter(obs_count == 1) %>%
  mutate(longitude = precise_longitude, latitude = precise_latitude) %>%
  create_region_scatter("#Obs: 1", lat_range, lon_range)

p_long_x_lat_obs2 <- summary_table_netcdf %>% filter(obs_count == 2) %>%
  mutate(longitude = precise_longitude, latitude = precise_latitude) %>%
  create_region_scatter("#Obs: 2", lat_range, lon_range)

p_long_x_lat_obs3000 <-summary_table_netcdf %>% 
  filter(obs_count >= 3000 & obs_count <= 3600) %>%
  mutate(longitude = precise_longitude, latitude = precise_latitude) %>%
  create_region_scatter("#Obs: 3000-3600", lat_range, lon_range)

p_long_x_lat_obs4000 <- summary_table_netcdf %>% filter(obs_count >= 4000) %>%
  mutate(longitude = precise_longitude, latitude = precise_latitude) %>%
  create_region_scatter("#Obs: ≥4000", lat_range, lon_range)

print(plot_grid(p_long_x_lat_obs1, p_long_x_lat_obs2, 
                p_long_x_lat_obs3000, p_long_x_lat_obs4000, nrow = 2))
```

---
